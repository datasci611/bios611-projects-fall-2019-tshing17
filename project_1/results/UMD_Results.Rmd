---
title: "Project 1"
author: "Tracie Shing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(ggpubr)

dat<-read_rds("C:/Users/tshin/Documents/GitHub/bios611-projects-fall-2019-tshing17/project_1/data/Anl_UMD_Services_190921.rds")
```

## Client Use of the Urban Ministries Resource Center

```{r create client summary}
client = dat %>%
  group_by(Client.File.Number) %>%
  summarise(
    total.visits=n(),
    first.date=min(mthdyyr),
    last.date=max(mthdyyr)) 

clientmultvis = summarise(client, multvisit=sum(total.visits>1), singlevisit=sum(total.visits<=1)) %>%
  mutate(propvisit=(multvisit/(multvisit+singlevisit))*100)

client2 = client %>%
  filter(total.visits>1) %>%
  mutate(visittime=as.numeric(last.date-first.date+1)/365) %>%
  mutate(visitrate = total.visits/visittime)
```

The Urban Ministries Center was founded in 1983.  In 2001, the Durham Community Shelter for HOPE, St. Philip's Community Cafe, and the United Methodist Mission Society merged to form Urban Ministries of Durham.  Therefore, service records through the years 2001 to June 2019 were assessed for client usage and client visits.

Between 2001 and June 2019 there were `r nrow(client)` clients that used the community resource center.  Clients include both single individuals and families.  The average number of visits for a client was `r round(mean(client$total.visits),2)` visits.  Of the `r nrow(client)` clients that used the resource center, `r round(clientmultvis$propvisit,2)`% used the resource more than once.  The average time these clients have been using the resource center, from their first visit to present, is `r round(mean(client2$visittime),2)` years.  This results in an average visit rate of `r round(mean(client2$visitrate),2)` visits per year.

### Client Use by Year

The number of clients who used the resource center and the number of visits are shown by year in **Figure 1**.

```{r create yearly plot}
year.client = dat %>%
  group_by(year, month, mthyr, Client.File.Number) %>%
  summarise(total.visits=n()) %>%
  arrange(Client.File.Number)

yearplot1a = year.client %>%
  group_by(year) %>%
  summarise(total.client=n())

yearplot1b = dat %>%
  group_by(year) %>%
  summarise(total.visits=n()) 

yearplot1c = full_join(yearplot1a, yearplot1b, by="year") %>% 
  gather(total.visits, total.client, key='type', value="n")

ggplot(yearplot1c, aes(x=year, y=n, color=type))+geom_point()+geom_line()+
  labs(x='Year', y='Total', title='Figure 1. Total Yearly Clients and Visits to UMD Resource Center 2001-2019')+
  theme_light()
```

There has been a steady increase in both the number of clients and the number of client visits to the resource center over time. It is important to note that this increase could be due to better data collection methods over time. 

There is always a greater number of client visits compared to clients as clients sometimes visit the resource center more than once.  However, in 2009 there appears to be a greater ratio of visits to clients suggests clients made more visits to the resource center than usual.

**Figure 1** shows a sharp decline at 2019, however this is due to the partial year data.  The current number of clients that have used the resource center between January and June of 2019 is `r yearplot1c %>% filter(year==2019, type=='total.client') %>% select(n)`.  If the same number of clients use the resource center in the second half of the year, then `r 2*(yearplot1c %>% filter(year==2019, type=='total.client') %>% select(n))` will use the resource center, which is more on trend with previous years.  Monthly trends may instead provide additional insight into the current year.

### Client Use by Month

The number of clients who used the resource center and the number of visits are shown by month in **Figure 2**.  Monthly trends could suggest seasonal or cyclic trends that may be important understand.

```{r create monthly plot}
monthplot1a = year.client %>%
  group_by(year, month, mthyr) %>%
  summarise(total.client=n())

monthplot1b = dat %>%
  group_by(year, month, mthyr) %>%
  summarise(total.visits=n()) 

monthplot1c = full_join(monthplot1a, monthplot1b, by=c("year","month","mthyr")) %>% 
  gather(total.visits, total.client, key='type', value="n")

ggplot(monthplot1c, aes(x=mthyr, y=n, color=type))+geom_point()+geom_line()+
  labs(x='Year',
       y='Total',
       title='Figure 2. Total Monthly Clients and Visits to UMD Resource Center 2001-2019')+
  scale_color_discrete(name = "Type", labels = c("Clients", "Visits"))+
  theme_light()

```

Again, there is the steady increase in both the number of clients and the number of client visits to the resource center over time. There are no obvious monthly signals according to **Figure 2**, however this may be due to the large number of months plotted.  Instead **Figure 3** shows the number of clients who used the resource center and the number of visits are shown by month for the last 5 years.

```{r create monthly plot 5 year}
monthplot2c = filter(monthplot1c, mthyr>=as.Date('2014-01-01'), mthyr<as.Date('2019-01-01'))
  
ggplot(monthplot2c, aes(x=mthyr, y=n, color=type))+geom_point()+geom_line()+
  labs(x='Month', 
       y='Total', 
       title='Figure 3. Total Monthly Clients and Visits to UMD Resource Center 2014-2018')+
  scale_color_discrete(name = "Type", labels = c("Clients", "Visits"))+
  theme_light()

```

**Figure 3** shows that there could be some monthly trends with the least number of clients visiting the resource center in January of 2015.

Monthly trends are better seen in **Figures 4 and 5** where the number of clients who used the resource center and the number of visits for the last 5 years are plotted simultaneously.

```{r create overlay monthly plot 5 year}
monthplot2c %>%
  filter(type=='total.client') %>%
  ggplot(aes(x=month, y=n, color=as.character(year)))+geom_point()+geom_line()+
  labs(x='Month', 
       y='Total Clients to Resource Center', 
       title='Figure 4. Total Monthly Clients to UMD Resource Center 2014-2018 (Overlay)')+
  theme_light()+
  scale_x_continuous(breaks=c(1,2,3,4,5,6,7,8,9,10,11,12), limits=c(1,12))+
  scale_color_discrete(name = "Year")

monthplot2c %>%
  filter(type=='total.visits') %>%
  ggplot(aes(x=month, y=n, color=as.character(year)))+geom_point()+geom_line()+
  labs(x='Month', 
       y='Total Visits to Resource Center', 
       title='Figure 5. Total Monthly Visits to UMD Resource Center 2014-2018 (Overlay)')+
  theme_light()+
  scale_x_continuous(breaks=c(1,2,3,4,5,6,7,8,9,10,11,12), limits=c(1,12))+
  scale_color_discrete(name = "Year")
```

In both 2016 and 2018, the least number of visits occurred in December, with `r filter(monthplot2c, year==2016, month==12, type=='total.visits')$n` and `r filter(monthplot2c, year==2018, month==1, type=='total.client')$n` visits respectively.  Similarly, in  2017, there was a large decrease in the number of visits that occurred between November and December.  There appear to have been the largest number of clients and visits to the resource in 2018 compared to all other years.

## Food Provided by Urban Ministries

Urban Ministries of Durham also provides both food and clothing to community members seeking assistance.  Data on the number of people in the family for which food was provided for each client was recorded consistently since 2001.  In 2006, Urban Ministries also began recording the amount of food in pounds that each client received at each visit.

```{r create client summary food provided}
dat = dat %>% mutate(yn.Food.Provided = ifelse(Food.Provided.for.b==0|is.na(Food.Provided.for.b), 0, 1))

food.client = dat %>%
  filter(yn.Food.Provided==1) %>%
  group_by(Client.File.Number) %>%
  summarise(ave.Food.Provided=mean(Food.Provided.for.b))
```

Between 2001 and June 2019 there were `r nrow(food.client)` clients that received food from the community resource center.  The average number of people in the family for which food was provided for a client was `r round(mean(food.client$ave.Food.Provided),2)`.  Therefore Urban Ministries served approximately `r nrow(food.client)*round(mean(food.client$ave.Food.Provided),2)` people from January 2001 to June 2019.

### Total Food Provided by Year

The total amount of food provided (in thousands of pounds) is shown by year in **Figure 6**.

```{r food provided year}
year.food.pounds = dat %>%
  group_by(year) %>%
  summarise( total.food.pounds = sum(Food.Pounds.b, na.rm=TRUE)) %>%
  arrange(year)
## really looks like they only collected Food in pounds data from 2006 onwards

ggplot(year.food.pounds, aes(x=year, y=total.food.pounds/1000))+geom_point()+geom_line()+
  labs(x='Year', y='Total Food in Thousands of Pounds', title='Figure 6. Total Food Provided by UMD 2001-2019')+
  theme_light()
```

Data on food in pounds was collected primarily beginning in 2006.  The flat trend from 2001-2005 is due to lack of data collection.  Similarly, the decline in 2019 is due to the partial year.  However, there is a noticeable increasing trend in the total amount of food provided between 2006 and 2018.  

### Total Food Provided by Month

In addition, the total amount of food provided (in pounds) is shown by month in **Figure 7**. 

```{r food provided month}
month.food.pounds = dat %>%
  group_by(year, month, mthyr) %>%
  summarise( total.food.pounds = sum(Food.Pounds.b, na.rm=TRUE)) %>%
  arrange(mthyr)

ggplot(month.food.pounds, aes(x=mthyr, y=total.food.pounds/1000))+geom_point()+geom_line()+
  labs(x='Year', y='Total Food in Thousands of Pounds', title='Figure 7. Total Monthly Food Provided by UMD 2001-2019')+
  theme_light()+
  geom_smooth(data=filter(month.food.pounds,year>=2006, year<=2010),method = "lm", se = FALSE)+
  geom_smooth(data=filter(month.food.pounds,year>2010),method = "lm", se = FALSE)
```

According to the monthly trend, the exact month data collection began appears to be in December of 2015. Overall, the total food provided does appear to be increasing between 2006 to June 2019.  However, there does appear to be a noticeable change in the rate of increase.  There is a lower rate of increase in the amount of food provided between 2011 and 2019 compared to the rate between 2006 and 2010.  This may be due to a function of better data collection.  Otherwise this suggests that there may be some stabilization in the total amount of food provided.


## Clothing Provided by Urban Ministries

```{r create client summary clothing}
dat = dat %>% mutate(yn.Clothing.Items = ifelse(Clothing.Items.b==0|is.na(Clothing.Items.b), 0, 1))

clothing.client = dat %>%
  filter(yn.Clothing.Items==1) %>%
  group_by(Client.File.Number) %>%
  summarise(ave.Clothing.Items=mean(Clothing.Items.b))
```

Records of the number of clothing items a client received was recorded since 2001.  Between 2001 and June 2019 there were `r nrow(clothing.client)` clients that received at least one clothing item from the community resource center.  The average number of clothing items each client received was `r round(mean(clothing.client$ave.Clothing.Items),2)`.  Urban Ministries provided a total of `r sum(dat$Clothing.Items.b, na.rm=TRUE)` items of clothing between January 2001 and June 2019.

### Total Clothing Items Provided by Year

The total number of clothing items provided by Urban Ministries is shown by year in **Figure 8**.

```{r clothing year}
year.clothing = dat %>%
  group_by(year) %>%
  summarise( total.clothing = sum(Clothing.Items.b, na.rm=TRUE)) %>%
  arrange(year)

ggplot(year.clothing, aes(x=year, y=total.clothing))+geom_point()+geom_line()+
  labs(x='Year', y='Total Clothing Items', title='Figure 8. Total Yearly Clothing Items Provided by UMD 2001-2019')+
  theme_light()
```

Overall there is an increasing trend in the total number of clothing items provided. There was a sharp increase in the number of clothing items that were provided between 2009 and 2010.  Since 2010, over 40,000 items of clothing were provided to clients each year with over 50,000 clothing items provided in 2014. The number of clothing items appears to be trending downward from 2014 to present.

### Total Clothing Items Provided by Month

Similarly, the total number of clothing items is shown by month in **Figure 9**. 

```{r clothing month}
month.clothing = dat %>%
  group_by(year, month, mthyr) %>%
  summarise( total.clothing = sum(Clothing.Items.b, na.rm=TRUE)) %>%
  arrange(mthyr)

ggplot(month.clothing, aes(x=mthyr, y=total.clothing))+geom_point()+geom_line()+
  labs(x='Year', y='Total Clothing Items', title='Figure 9. Total Monthly Clothing Items Provided by UMD 2001-2019')+
  theme_light()+
  geom_smooth(data=filter(month.clothing,year>=2002, year<2009),method = "lm", se = FALSE)+
  geom_smooth(data=filter(month.clothing,year>=2009),method = "lm", se = FALSE)
```

According to the monthly trends, the number of clothing items provided was only recorded beginning in 2002. There are two distinct trends in the number of clothing items provided: a steady increase but lower total between 2002 and 2008 and a slight increase but larger total items between 2009 to June 2019.  Interestingly, the amount of total clothing items fluctuates greatly between 2009 and June 2019 whereas the monthly fluctuations between 2002 and 2008 are minimal.

## Relationship between Resources and Funding

```{r}
irs<-read.delim("C:/Users/tshin/Documents/GitHub/bios611-projects-fall-2019-tshing17/project_1/data/UMD IRS 990.txt", sep='\t', header=TRUE)
```
The IRS requires all U.S. tax-exempt nonprofits to make their three most recent Form 990 or 990-PF annual returns (commonly called "990s") publicly available.  IRS forms 990 for Urban Ministries of Durham for calendar years 2000-2017 can be found on [ProPublica](https://projects.propublica.org/nonprofits/organizations/581505891).  Total contributions and grants and non-cash Contributions are plotted over time in **Figure 10**.

```{r message=FALSE, warning=FALSE}
irs2 = irs %>% 
  mutate(Cash.Contributions=Contributions.and.Grants-Noncash.Contributions)%>%
  gather(Contributions.and.Grants, Noncash.Contributions, Cash.Contributions, key='type', value='contributions')

ggplot(irs2, aes(x=Calendar.Year, y=contributions/1000, color=type))+geom_point()+geom_line()+
  labs(x='Year', y='Contributions in Thousands of Dollars', title='Figure 10. Contributions to UMD According to IRS Form 990, 2000-2017')+
  theme_light()+
  scale_color_discrete(name = "Type", 
                       limits = c('Contributions.and.Grants', 'Cash.Contributions','Noncash.Contributions'),
                       labels = c("Total Contributions", "Cash Contributions", "Non-Cash Contributions"))
```

The total contributions appear to be increasing over time.  However, while cash contributions appear to be increasing over time, non-cash contributions appear to be stagnant after 2013.  Due to these different trends, we will assess the correlation between cash contributions and resources separately from non-cash contributions.  Only the years from 2005-2017 will be assessed.

```{r create food corr data}
v.food.pounds = year.food.pounds %>% 
  filter(year>=2005, year<=2017) %>% 
  select(year, total.food.pounds) %>%
  arrange(year)

v.irs = irs %>% filter(Calendar.Year>=2005, Calendar.Year<=2017) %>% 
  mutate(Cash.Contributions=Contributions.and.Grants-Noncash.Contributions)%>%
  select(Calendar.Year, Cash.Contributions, Noncash.Contributions)%>%
  arrange(Calendar.Year)

corr.food = full_join(v.food.pounds, v.irs, by = c("year" = "Calendar.Year"))

```

**Figures 11 & 12** show the correlation between contributions according to IRS 990 forms and the yearly total food in pounds provided.

```{r create food corr plots}

ggscatter(corr.food, y = "total.food.pounds", x = "Cash.Contributions", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          ylab = "Total Food in Pounds", xlab = "Cash Contributions",
          title = "Figure 11. Pearson Correlation between Cash Contributions \n(2005-2017) and Food in Pounds")

ggscatter(corr.food, y = "total.food.pounds", x = "Noncash.Contributions", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          ylab = "Total Food in Pounds", xlab = "Non-cash Contributions",
          title = "Figure 12. Pearson Correlation between Non-Cash Contributions \n(2005-2017) and Food in Pounds")
```

There is a slightly higher correlation between non-cash contributions and total food in pounds compared to the correlation between cash contributions and total food in pounds.

Similar correlations were assessed for the yearly total clothing items provided.


```{r create clothing corr data}
v.clothing = year.clothing %>% 
  filter(year>=2005, year<=2017) %>% 
  select(year, total.clothing) %>%
  arrange(year)

corr.clothing = full_join(v.clothing, v.irs, by = c("year" = "Calendar.Year"))

```

**Figures 13 & 14** show the correlation between contributions according to IRS 990 forms and the total clothing provided.

```{r create clothing corr plots}

ggscatter(corr.clothing, y = "total.clothing", x = "Cash.Contributions", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          ylab = "Total Clothing Items", xlab = "Cash Contributions",
          title = "Figure 12. Pearson Correlation between Cash Contributions \n(2005-2017) and Clothing Items Provided")

ggscatter(corr.clothing, y = "total.clothing", x = "Noncash.Contributions", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          ylab = "Total Food in Pounds", xlab = "Non-cash Contributions",
          title = "Figure 12. Pearson Correlation between Non-Cash Contributions \n(2005-2017) and Clothing Items Provided")
```

There are slightly lower correlations between both non-cash and cash contributions and total clothing items compared to the correlations with food.  However again, the correlation between non-cash contributions and total clothing items compared to the correlation between cash contributions and total clothing items is higher.

## Conclusions

Urban Ministries has served over 15000 clients since 2001.  The number of clients who visit the Urban Ministries Resource Center continues to increase each year.  Additionally, this corresponds to an increasing number of visits to the resource center where clients are able to obtain food and clothing.  In 2018 alone, Urban Ministries provided over 125,000 pounds of food to clients.  While the amount of food in pounds is also increasing, there is some indication that the number of clothing items provided may be in decline.

The overall increasing trends in all aspects of Urban Ministries services may be a function of better data collection over time.  However, the trends in food and clothing suggest that either additional clothing resources are needed or clients are seeking clothing items less often. It is also possible that clients are seeking food over clothing items.  It would be of interest to determine what items clients actually need when they visit the center in comparison to what they are able to receive.

The amount of food provided and the amount of clothing provided appears to be correlated with the amount of contributions and grants received.  Cash contributions appear to have a higher correlation with food provided, more so than clothing items.  As expected, non-cash contributions are highly correlated with the amount of food and total clothing items provided.  This supports and highlights the benefit food and clothing donations drives.  However, as data from the IRS suggests, non-cash contributions have been stagnant in the last few years.  Increased donation drives to obtain food and clothing rather than cash may be an area of future improvement for Urban Ministries to directly benefits clients.








